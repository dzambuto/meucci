/*! protocol 16-04-2013 */
(function(t,r){"object"==typeof exports?module.exports=r(require("socket.io-client"),require("q")):"function"==typeof define&&define.amd?define("protocol",["io","Q"],r):t.protocol=r(t.io,t.Q)})(this,function(t,r){function e(){function t(r,e){return"string"==typeof r?new t.route(r,e,t):t}return o(t,proto),t.procedures=[],t.callbacks=[],t.plugins=[],t}function n(t,r,e,n){return t instanceof RegExp?t:(t instanceof Array&&(t="("+t.join("|")+")"),t=t.concat(n?"":"/?").replace(/\/\(/g,"(?:/").replace(/(\/)?(\.)?:(\w+)(?:(\(.*?\)))?(\?)?/g,function(t,e,n,o,i,s){return r.push({name:o,optional:!!s}),e=e||"",""+(s?"":e)+"(?:"+(s?e:"")+(n||"")+(i||n&&"([^/.]+?)"||"([^/]+?)")+")"+(s||"")}).replace(/([\/.])/g,"\\$1").replace(/\*/g,"(.*)"),RegExp("^"+t+"$",e?"":"i"))}function o(t,r){if(t&&r)for(var e in r)t[e]=r[e];return t}function i(t,e,n){var o=r.defer();return n.emit("event",{path:t,args:e,rpc:!0},function(t){t.res?o.resolve(t.res):o.reject(Error(t.err))}),o.promise}return proto={},proto.handle=function(t,r){for(var e=0;this.callbacks.length>e;++e)this.callbacks[e](t,r)},proto.rpc=function(t,r,e){function n(s){var a=i.procedures[o++];if(!a)return s?e({res:s}):e({err:"Procedure not found."});try{if(s)return e(s);a(t,r,n)}catch(c){n({err:c})}}var o=0,i=this;n()},proto.dispatch=function(t,r){function e(s){var a=i.plugins[n++];if(!a)return s?r?r({err:s}):!1:o?i.rpc(t.path,t.args,r):(i.handle(t.path,t.args),i.broadcast&&i.broadcast(t.path,t.args,t.connection),r?r({res:!0}):!0);try{s?3==a.length?a(s,t,e):e(s):3>a.length?a(t,e):e()}catch(c){e(c)}}var n=0,o=t.rpc,i=this;e()},proto.use=function(){return this("*").use.apply(null,arguments)},proto.reset=function(){return this.callbacks=[],this.plugins=[],this.procedures=[],this},proto.route=function(t,r,e,o){return o=o||{},this.path=t,this.parent=e,r&&(this.sockets=r.length?r:[r]),this.regexp=n(t,this.keys=[],o.sensitive,o.strict),this},proto.route.prototype.use=function(){for(var t=0;arguments.length>t;++t)this.parent.plugins.push(this.middleware(arguments[t]));return this},proto.route.prototype.respond=function(){return arguments.length?(this.parent.procedures.push(this.callback(arguments[0])),this):this},proto.route.prototype.middleware=function(t){var r=this,e=t.length;return 2==e?function(e,n){return r.match(e.path,e.params)?t(e,n):(n(),void 0)}:3==e?function(e,n,o){return r.match(n.path,n.params)?t(e,n,o):(o(),void 0)}:void 0},proto.route.prototype.callback=function(t){var r,e,n=this;t instanceof Array?(r=t[0],e=t[1]):(r=t,e=null);var o=function(t,o,i){var s=[];if(n.match(t,s)){var a=s.concat(o||[]);return i&&a.push(i),r.apply(e,a)}};return o.match=function(t,e){return e==r&&n.match(t,[])},o.path=function(t){return n.match(t,[])},o},proto.route.prototype.match=function(t,r){var e=this.keys,n=t.indexOf("?"),o=~n?t.slice(0,n):t,i=this.regexp.exec(o);if(!i)return!1;for(var s=1,a=i.length;a>s;++s){var c=e[s-1],p="string"==typeof i[s]?decodeURIComponent(i[s]):i[s];c?(r[c.name]=void 0!==r[c.name]?r[c.name]:p,r.push(p)):r.push(p)}return!0},proto.route.prototype.subscribe=function(){for(var t=this.sockets||this.parent.socket,r=this.parent.callbacks,e=function(){},n=0;arguments.length>n;++n)r.push(this.callback(arguments[n]));if(!this.keys.length)if(t.length)for(var o=0;t.length>o;o++)t[o].emit("subscribe",{path:this.path},e);else t.emit("subscribe",{path:this.path},e);return this},proto.route.prototype.unsubscribe=function(){for(var t=this.path,r=this.sockets||this.parent.socket,e=this.parent.callbacks,n=!0,o=function(){},i=0;arguments.length>i;++i)for(var s=0,a=e.length,c=0;a>c;++c){var p=c-s,u=e[p];u.match(t,arguments[i])?(e.splice(p,1),s++):u.path(t)&&(n=!1)}if(n)if(r.length)for(var h=0;r.length>h;h++)r[h].emit("unsubscribe",{path:this.path},o);else r.emit("unsubscribe",{path:this.path},o);return this},proto.route.prototype.publish=function(){var t=Array.prototype.slice.apply(arguments);return this.parent.handle(this.path,t),this.parent.emit(this.path,t,this.sockets||this.parent.socket),this},proto.route.prototype.request=function(){var t=Array.prototype.slice.apply(arguments),e=[],n=this.path,o=this.sockets||this.parent.socket;if(!o.length)return i(n,t,o);for(var s=0;o.length>s;s++)e.push(i(n,t,o[s]));return r.all(e)},proto.connect=function(r,e){return e=e||{},this.socket=t.connect(r,e),this.init(this.socket),t},proto.init=function(t){function r(r,e){var o={};return o.connection=t,o.app=n,o.params=[],o.error=function(t){e({err:t||"Unknown Error."})},o.done=function(){e({res:!0})},o.send=function(t){e({res:t||!0})},o.end=function(t){e({res:t||!0}),this.connection.disconnect()},r.path&&r.args?(o.path=r.path,o.args=r.args,o.rpc=r.rpc||!1,n.dispatch(o,e),void 0):e({err:"Invalid message."})}function e(){}var n=this;t.on("event",r),t.on("disconnect",e)},proto.emit=function(t,r,e){var n=function(){};if(e&&e.length)for(var o=0;e.length>o;o++)e[o].emit("event",{path:t,args:r},n);else e&&e.emit("event",{path:t,args:r},n)},proto.initStorage=function(){},e});