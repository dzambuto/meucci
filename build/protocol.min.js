/*! protocol 17-04-2013 */
(function(t,r){"undefined"!=typeof module&&module.exports?exports=module.exports=r(require("socket.io-client"),require("q")):"function"==typeof define&&define.amd?define("protocol",["io","Q"],r):t.protocol=r(t.io,t.Q)})(this,function(t,r){function e(){function t(r,e){return"string"==typeof r?new t.route(r,e,t):t}return i(t,u),t.procedures=[],t.callbacks=[],t.plugins=[],t}function n(t,r,e,n){return t instanceof RegExp?t:(t instanceof Array&&(t="("+t.join("|")+")"),t=t.concat(n?"":"/?").replace(/\/\(/g,"(?:/").replace(/(\/)?(\.)?:(\w+)(?:(\(.*?\)))?(\?)?/g,function(t,e,n,i,s,o){return r.push({name:i,optional:!!o}),e=e||"",""+(o?"":e)+"(?:"+(o?e:"")+(n||"")+(s||n&&"([^/.]+?)"||"([^/]+?)")+")"+(o||"")}).replace(/([\/.])/g,"\\$1").replace(/\*/g,"(.*)"),RegExp("^"+t+"$",e?"":"i"))}function i(t,r){if(t&&r)for(var e in r)t[e]=r[e];return t}function s(t,e,n){var i=r.defer();return n.emit(t,e,function(t){t.res?i.resolve(t.res):i.reject(Error(t.err))}),i.promise}function o(t,e,n){var i=[];if(!n.length)return s(t,e,n);for(var o=0;n.length>o;o++)i.push(s(t,e,n[o]));return r.all(i)}function a(t,r,e){if(e.length)for(var n=0;e.length>n;n++)e[n].emit(t,r);else e.emit(t,r)}function c(t,r,e){for(var n=!0,i=0;r.length>i;++i)for(var s=0,o=e.length,a=0;o>a;++a){var c=a-s,u=e[c];u.match(t,r[i])?(e.splice(c,1),s++):u.path(t)&&(n=!1)}return n}var u={};return u.handle=function(t,r){for(var e=0;this.callbacks.length>e;++e)this.callbacks[e](t,r)},u.rpc=function(t,r,e){function n(o){var a=s.procedures[i++];if(!a)return o?e({res:o}):e({err:"Procedure not found."});try{if(o)return e(o);a(t,r,n)}catch(c){n({err:c})}}var i=0,s=this;n()},u.dispatch=function(t,r){function e(o){var a=s.plugins[n++];if(!a)return o?r?r({err:o}):!1:i?s.rpc(t.path,t.args,r):(s.handle(t.path,t.args),s.broadcast&&s.broadcast(t.path,t.args,t.connection),r?r({res:!0}):!0);try{o?3==a.length?a(o,t,e):e(o):3>a.length?a(t,e):e()}catch(c){e(c)}}var n=0,i=t.rpc,s=this;e()},u.use=function(){return this("*").use.apply(null,arguments)},u.reset=function(){return this.callbacks=[],this.plugins=[],this.procedures=[],this},u.route=function(t,r,e,i){return i=i||{},this.path=t,this.parent=e,r&&(this.sockets=r.length?r:[r]),this.regexp=n(t,this.keys=[],i.sensitive,i.strict),this.pattern=this.keys.length||~this.path.indexOf("*")?!0:!1,this},u.route.prototype.use=function(){for(var t=0;arguments.length>t;++t)this.parent.plugins.push(this.middleware(arguments[t]));return this},u.route.prototype.respond=function(){return arguments.length?(this.parent.procedures.push(this.callback(arguments[0])),this):this},u.route.prototype.request=function(){var t=Array.prototype.slice.apply(arguments),r=this.path,e=this.sockets||this.parent.socket;return e?o("event",{path:r,args:t,rpc:!0},e):this},u.route.prototype.middleware=function(t){var r=this,e=t.length;return 2==e?function(e,n){return r.match(e.path,e.params)?t(e,n):(n(),void 0)}:3==e?function(e,n,i){return r.match(n.path,n.params)?t(e,n,i):(i(),void 0)}:void 0},u.route.prototype.callback=function(t){var r,e,n=this;t instanceof Array?(r=t[0],e=t[1]):(r=t,e=null);var i=function(t,i,s){var o=[];if(n.match(t,o)){var a=o.concat(i||[]);return s&&a.push(s),r.apply(e,a)}};return i.match=function(t,e){return e==r&&n.match(t,[])},i.path=function(t){return n.match(t,[])},i},u.route.prototype.match=function(t,r){var e=this.keys,n=t.indexOf("?"),i=~n?t.slice(0,n):t,s=this.regexp.exec(i);if(!s)return!1;for(var o=1,a=s.length;a>o;++o){var c=e[o-1],u="string"==typeof s[o]?decodeURIComponent(s[o]):s[o];c?(r[c.name]=void 0!==r[c.name]?r[c.name]:u,r.push(u)):r.push(u)}return!0},u.route.prototype.subscribe=function(){for(var t=this.path,r=this.sockets||this.parent.socket,e=this.parent.callbacks,n=0;arguments.length>n;++n)e.push(this.callback(arguments[n]));return this.pattern||a("subscribe",{path:t},r),this},u.route.prototype.unsubscribe=function(){var t=this.path,r=this.sockets||this.parent.socket,e=this.parent.callbacks;return c(t,arguments,e)&&a("unsubscribe",{path:t},r),this},u.route.prototype.publish=function(){var t=Array.prototype.slice.apply(arguments),r=this.path,e=this.sockets||this.parent.socket;return this.parent.handle(this.path,t),e?o("event",{path:r,args:t},e):this},u.connect=function(r,e){return e=e||{},this.socket=t.connect(r,e),this.init(this.socket),t},u.init=function(t){function r(r,e){var i={};return i.connection=t,i.app=n,i.params=[],i.error=function(t){e({err:t||"Unknown Error."})},i.done=function(){e({res:!0})},i.send=function(t){e({res:t||!0})},i.end=function(t){e({res:t||!0}),this.connection.disconnect()},r.path&&r.args?(i.path=r.path,i.args=r.args,i.rpc=r.rpc||!1,n.dispatch(i,e),void 0):e({err:"Invalid message."})}function e(){}var n=this;t.on("event",r),t.on("disconnect",e)},u.initStorage=function(){},e});