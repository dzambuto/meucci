/*! meucci 09-05-2013 */
(function(t,e){"undefined"!=typeof module&&module.exports?exports=module.exports=e(require("socket.io-client"),require("q")):"function"==typeof define&&define.amd?define("meucci",["io","Q"],e):t.protocol=e(t.io,t.Q)})(this,function(t,e){function r(){function t(e,r){return"string"==typeof e?new t.route(e,r,t):t}return s(t,h),t.procedures=[],t.callbacks=[],t.plugins=[],t}function n(t,e,r,n){return t instanceof RegExp?t:(t instanceof Array&&(t="("+t.join("|")+")"),t=t.concat(n?"":"/?").replace(/\/\(/g,"(?:/").replace(/(\/)?(\.)?:(\w+)(?:(\(.*?\)))?(\?)?/g,function(t,r,n,i,s,o){return e.push({name:i,optional:!!o}),r=r||"",""+(o?"":r)+"(?:"+(o?r:"")+(n||"")+(s||n&&"([^/.]+?)"||"([^/]+?)")+")"+(o||"")}).replace(/([\/.])/g,"\\$1").replace(/\*/g,"(.*)"),RegExp("^"+t+"$",r?"":"i"))}function s(t,e){if(t&&e)for(var r in e)t[r]=e[r];return t}function o(t,r,n){var i=e.defer();return n.emit(t,r,function(t){t.res?i.resolve(t.res):i.reject(Error(t.err))}),i.promise}function a(t,r,n){if(!n){var i=e.defer();return i.resolve(),i.promise}if(!n.length)return o(t,r,n);for(var s=[],a=0;n.length>a;a++)s.push(o(t,r,n[a]));return e.all(s)}function c(t,e,r){if(r.length)for(var n=0;r.length>n;n++)r[n].emit(t,e);else r.emit(t,e)}function u(t,e,r){for(var n=!0,i=0;e.length>i;++i)for(var s=0,o=r.length,a=0;o>a;++a){var c=a-s,u=r[c];u.match(t,e[i])?(r.splice(c,1),s++):u.path(t)&&(n=!1)}return n}var h={};return h.handle=function(t,e){for(var r=0;this.callbacks.length>r;++r)this.callbacks[r](t,e)},h.rpc=function(t,e,r){function n(o){var a=s.procedures[i++];if(!a)return o?r({res:o}):r({err:"Procedure not found."});try{if(o)return r(o);a(t,e,n)}catch(c){n({err:c})}}var i=0,s=this;n()},h.dispatch=function(t,e){function r(o){var a=s.plugins[n++];if(!a)return o?e?e({err:o}):!1:i?s.rpc(t.path,t.args,e):(s.handle(t.path,t.args),s.broadcast&&s.broadcast(t.path,t.args,t.connection),e?e({res:!0}):!0);try{o?3==a.length?a(o,t,r):r(o):3>a.length?a(t,r):r()}catch(c){r(c)}}var n=0,i=t.rpc,s=this;r()},h.use=function(){return this("*").use.apply(null,arguments)},h.reset=function(){return this.callbacks=[],this.plugins=[],this.procedures=[],this.listeners&&(this.listeners={}),this},h.bind=function(t,e,r){this.listeners=this.listeners||{};var n=this.listeners[t]=this.listeners[t]||[];n.push([e,r])},h.unbind=function(t,e,r){if(this.listeners&&this.listeners[t]){if(!e)return delete this.listeners[t],void 0;var n=this.listeners[t];for(n.length;i--;)e===n[i][0]&&(r&&n[i][1]!==r||n.splice(i,1))}},h.trigger=function(t){var e=Array.prototype.slice.call(arguments,1);if(this.listeners&&this.listeners[t])for(var r=this.listeners[t],n=r.length,i=0;n>i;i++)r[i][0].apply(r[i][1],e)},h.route=function(t,e,r,i){return i=i||{},this.path=t,this.parent=r,e&&(this.sockets=e.length?e:[e]),this.regexp=n(t,this.keys=[],i.sensitive,i.strict),this.pattern=this.keys.length||~this.path.indexOf("*")?!0:!1,this},h.route.prototype.use=function(){for(var t=0;arguments.length>t;++t)this.parent.plugins.push(this.middleware(arguments[t]));return this},h.route.prototype.respond=function(){return arguments.length?(this.parent.procedures.push(this.callback(arguments[0])),this):this},h.route.prototype.request=function(){var t=Array.prototype.slice.apply(arguments),e=this.path,r=this.sockets||this.parent.socket;return r?a("event",{path:e,args:t,rpc:!0},r):this},h.route.prototype.middleware=function(t){var e=this,r=t.length;return 2==r?function(r,n){return e.match(r.path,r.params)?t(r,n):(n(),void 0)}:3==r?function(r,n,i){return e.match(n.path,n.params)?t(r,n,i):(i(),void 0)}:void 0},h.route.prototype.callback=function(t){var e,r,n=this;t instanceof Array?(e=t[0],r=t[1]):(e=t,r=null);var i=function(t,i,s){var o=[];if(n.match(t,o)){var a=o.concat(i||[]);return s&&a.push(s),e.apply(r,a)}};return i.match=function(t,r){return r==e&&n.match(t,[])},i.path=function(t){return n.match(t,[])},i},h.route.prototype.match=function(t,e){var r=this.keys,n=t.indexOf("?"),i=~n?t.slice(0,n):t,s=this.regexp.exec(i);if(!s)return!1;for(var o=1,a=s.length;a>o;++o){var c=r[o-1],u="string"==typeof s[o]?decodeURIComponent(s[o]):s[o];c?(e[c.name]=void 0!==e[c.name]?e[c.name]:u,e.push(u)):e.push(u)}return!0},h.route.prototype.subscribe=function(){for(var t=this.path,e=this.sockets||this.parent.socket,r=this.parent.callbacks,n=0;arguments.length>n;++n)r.push(this.callback(arguments[n]));return this.pattern?a("subscribe",{path:t},void 0):a("subscribe",{path:t},e)},h.route.prototype.unsubscribe=function(){var t=this.path,e=this.sockets||this.parent.socket,r=this.parent.callbacks;return u(t,arguments,r)?c("unsubscribe",{path:t},e):this},h.route.prototype.publish=function(){var t=Array.prototype.slice.apply(arguments),e=this.path,r=this.sockets||this.parent.socket;return this.parent.handle(this.path,t),r?a("event",{path:e,args:t},r):this},h.connect=function(e,r){return r=r||{},this.socket=t.connect(e,r),this.init(this.socket),t},h.init=function(t){function e(e,r){var n={};return n.connection=t,n.app=s,n.params=[],n.error=function(t){r({err:t||"Unknown Error."})},n.done=function(){r({res:!0})},n.send=function(t){r({res:t||!0})},n.end=function(t){r({res:t||!0}),this.connection.disconnect()},e.path&&e.args?(n.path=e.path,n.args=e.args,n.rpc=e.rpc||!1,s.dispatch(n,r),void 0):r({err:"Invalid message."})}function r(){s.trigger("connection:up",t)}function n(){s.trigger("connection:down",t)}function i(e){s.trigger("connection:failed",e,t)}var s=this;t.on("event",e),t.on("connect",r),t.on("disconnect",n),t.on("connect_failed",i)},h.initStorage=function(){},r});