/*! meucci 15-05-2013 */
(function(t,e){"undefined"!=typeof module&&module.exports?exports=module.exports=e(require("socket.io-client"),require("q")):"function"==typeof define&&define.amd?define("meucci",["io","Q"],e):"undefined"!=typeof angular&&angular.injector?angular.module("angular.meucci",[]).factory("meucci",["$window","$q",function(t,n){return e(t.io,n)}]):t.meucci=e(t.io,t.Q)})(this,function(t,e){function n(){function t(e,n){return"string"==typeof e?new t.route(e,n,t):t}return s(t,h),t.init(),t}function r(t,e,n,r){return t instanceof RegExp?t:(t instanceof Array&&(t="("+t.join("|")+")"),t=t.concat(r?"":"/?").replace(/\/\(/g,"(?:/").replace(/(\/)?(\.)?:(\w+)(?:(\(.*?\)))?(\?)?/g,function(t,n,r,s,i,o){return e.push({name:s,optional:!!o}),n=n||"",""+(o?"":n)+"(?:"+(o?n:"")+(r||"")+(i||r&&"([^/.]+?)"||"([^/]+?)")+")"+(o||"")}).replace(/([\/.])/g,"\\$1").replace(/\*/g,"(.*)"),RegExp("^"+t+"$",n?"":"i"))}function s(t,e){if(t&&e)for(var n in e)t[n]=e[n];return t}function o(t,n,r){var s=e.defer();return r.emit(t,n,function(t){t.res?s.resolve(t.res):s.reject(Error(t.err))}),s.promise}function a(t,n,r){if(!r){var s=e.defer();return s.resolve(),s.promise}if(!r.length)return o(t,n,r);for(var i=[],a=0;r.length>a;a++)i.push(o(t,n,r[a]));return e.all(i)}function c(t,e,n){if(n.length)for(var r=0;n.length>r;r++)n[r].emit(t,e);else n.emit(t,e)}function u(t,e,n){for(var r=!0,s=0;e.length>s;++s)for(var i=0,o=n.length,a=0;o>a;++a){var c=a-i,u=n[c];u.match(t,e[s])?(n.splice(c,1),i++):u.path(t)&&(r=!1)}return r}var h={};return h.init=function(){this.procedures=[],this.callbacks=[],this.plugins=[],this.settings={},this.defaultConfiguration()},h.defaultConfiguration=function(){var t=this;this.set("env",process.env.NODE_ENV||"development"),this.bind("app:mounted",function(e){var n=t;n.parent=e,e.socket&&(n.socket=e.socket),e.io&&(n.io=e.io)})},h.initSocket=function(t){function e(e,r){if(!e.path)return r({err:"Invalid message."});var s={path:e.path,args:e.args,rpc:e.rpc,socket:t,ack:r,client:!h.listen},i=n.requestMessage(s),o=n.responseMessage(s);n.dispatch(i,o)}var n=this;t.on("event",e),this.events(t)},h.set=function(t,e){return 1==arguments.length?this.settings[t]:(this.settings[t]=e,this)},h.get=function(t){return this.settings[t]},h.enable=function(t){return this.set(t,!0)},h.disable=function(t){return this.set(t,!1)},h.enabled=function(t){return!!this.set(t)},h.disabled=function(t){return!this.set(t)},h.handle=function(t,e){for(var n={path:t,args:e,client:!this.listen},r=this.requestMessage(n),s=this.responseMessage(n),i=function(){},o=0;this.callbacks.length>o;++o)this.callbacks[o](r,s,i)},h.dispatch=function(t,e,n){function r(o){var a=i[s++];if(!a||e.messageSent)return n?n(o):(o?e.error(o):t.rpc?e.error("Procedure not found"):(e.broadcast(),e.done()),void 0);try{o?4==a.length?a(o,t,e,r):r(o):3==a.length?a(t,e,r):r()}catch(c){r(c)}}var s=0,i=t.rpc?this.plugins.concat(this.procedures):this.plugins.concat(this.callbacks);r()},h.use=function(){return this("*").use.apply(null,arguments)},h.reset=function(){return this.callbacks=[],this.plugins=[],this.procedures=[],this.listeners&&(this.listeners={}),this},h.bind=function(t,e,n){this.listeners=this.listeners||{};var r=this.listeners[t]=this.listeners[t]||[];r.push([e,n])},h.unbind=function(t,e,n){if(this.listeners&&this.listeners[t]){if(!e)return delete this.listeners[t],void 0;var r=this.listeners[t];for(r.length;i--;)e===r[i][0]&&(n&&r[i][1]!==n||r.splice(i,1))}},h.trigger=function(t){var e=Array.prototype.slice.call(arguments,1);if(this.listeners&&this.listeners[t])for(var n=this.listeners[t],r=n.length,s=0;r>s;s++)n[s][0].apply(n[s][1],e)},h.requestMessage=function(t){if(t&&t.path){var e={},n=t.ack;return e.path=t.path,e.args=t.args||[],e.rpc=t.rpc||!1,e.app=this,e.params=[],t.socket&&(e.connection=t.socket),t.res&&(e.res=t.res),e.end=function(t){this.res&&this.res.messageSent=!0,n&&n({res:t||!0}),this.connection.disconnect()},e}},h.responseMessage=function(t){if(t&&t.path){var e={},n=t.ack;return e.path=t.path,e.args=t.args||[],e.rpc=t.rpc||!1,e.app=this,e.params=[],t.socket&&(e.connection=t.socket),t.req&&(e.req=t.res),e.error=function(t){this.messageSent=!0,n&&n({err:t||"Unknown Error."})},e.done=function(){this.messageSent=!0,n&&n({res:!0})},e.send=function(t){this.messageSent=!0,n&&n({res:t||!0})},e.end=function(t){this.messageSent=!0,n&&n({res:t||!0}),this.connection.disconnect()},e.broadcast=function(){var t=this.path,e=this.args;this.connection.broadcast&&this.connection.broadcast.to(t).emit("event",{path:t,args:e})},e}},h.route=function(t,e,n,s){return s=s||{},this.path=t,this.parent=n,e&&(this.sockets=e.length?e:[e]),this.regexp=r(t,this.keys=[],s.sensitive,s.strict),this.pattern=this.keys.length||~this.path.indexOf("*")?!0:!1,this},h.route.prototype.use=function(){for(var t=0;arguments.length>t;++t)this.parent.plugins.push(this.middleware(arguments[t]));return this},h.route.prototype.respond=function(){return arguments.length?(this.parent.procedures.push(this.callback(arguments[0])),this):this},h.route.prototype.request=function(){var t=Array.prototype.slice.apply(arguments),e=this.path,n=this.sockets||this.parent.socket;return n?a("event",{path:e,args:t,rpc:!0},n):this},h.route.prototype.middleware=function(t){var e=this,n=t.length;if("function"==typeof t.dispatch){var r=t;return e.parent.bind("service:started",function(){e.parent.socket&&(r.socket=e.parent.socket),e.parent.io&&(r.io=e.parent.io)}),r.trigger("app:mounted",e.parent),function(t,n,s){return e.match(t.path,t.params)?r.dispatch(t,n,s):(s(),void 0)}}return 3==n?function(n,r,s){return e.match(n.path,n.params)?t(n,r,s):(s(),void 0)}:4==n?function(n,r,s,i){return e.match(r.path,r.params)?t(n,r,s,i):(i(),void 0)}:void 0},h.route.prototype.callback=function(t){var e,n,r=this;if("function"!=typeof t.dispatch){t instanceof Array?(e=t[0],n=t[1]):(e=t,n=null);var s=function(t,s,i){function o(t){s.send(t)}if(t.params=[],r.match(t.path,t.params)){var a=t.params;a=t.args?a.concat(t.args):a,t.rpc&&a.push(o);var c=e.apply(n,a);return t.rpc&&!s.messageSent&&s.send(c),t.rpc?c:i()}i()};return s.match=function(t,n){return n==e&&r.match(t,[])},s.path=function(t){return r.match(t,[])},s}},h.route.prototype.match=function(t,e){var n=this.keys,r=t.indexOf("?"),s=~r?t.slice(0,r):t,i=this.regexp.exec(s);if(!i)return!1;for(var o=1,a=i.length;a>o;++o){var c=n[o-1],u="string"==typeof i[o]?decodeURIComponent(i[o]):i[o];c?(e[c.name]=void 0!==e[c.name]?e[c.name]:u,e.push(u)):e.push(u)}return!0},h.route.prototype.subscribe=function(){for(var t=this.path,e=this.sockets||this.parent.socket,n=this.parent.callbacks,r=0;arguments.length>r;++r)n.push(this.callback(arguments[r]));return this.pattern?a("subscribe",{path:t},void 0):a("subscribe",{path:t},e)},h.route.prototype.unsubscribe=function(){var t=this.path,e=this.sockets||this.parent.socket,n=this.parent.callbacks;return u(t,arguments,n)?c("unsubscribe",{path:t},e):this},h.route.prototype.publish=function(){var t=Array.prototype.slice.apply(arguments),e=this.path,n=this.sockets||this.parent.socket;return this.parent.handle(this.path,t),n?a("event",{path:e,args:t},n):this},h.connect=function(e,n){return n=n||{},this.socket=t.connect(e,n),this.initSocket(this.socket),t},h.events=function(t){function e(){s.trigger("connection:up",t)}function n(){s.trigger("connection:down",t)}function r(e){s.trigger("connection:failed",e,t)}var s=this;t.on("connect",e),t.on("disconnect",n),t.on("connect_failed",r)},h.initStorage=function(){},n});